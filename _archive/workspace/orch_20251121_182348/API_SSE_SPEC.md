# API & SSE Specification

## Overview
The API provides a RESTful interface for the Dashboard and CLI, utilizing Server-Sent Events (SSE) for real-time updates. All endpoints are **session-scoped**.

**Base URL**: `http://localhost:8000/api/v1`

## Endpoints

### Session Management
- `POST /orchestrate`
  - **Body**: `{ "prompt": "Build a todo app", "target_dir": "..." }`
  - **Returns**: `{ "session_id": "orch_2025...", "status": "initializing" }`
- `GET /sessions`
  - **Returns**: `[{ "id": "...", "status": "running", "created_at": "..." }]`

### Session Control
- `POST /{session_id}/pause`
- `POST /{session_id}/resume`
- `POST /{session_id}/stop`
- `POST /{session_id}/review` (Trigger manual review)

### Data Access
- `GET /{session_id}/state` (Full current state snapshot)
- `GET /{session_id}/logs/{agent_name}` (Raw logs)

## SSE Specification (Real-Time Stream)

**Endpoint**: `GET /{session_id}/events`

### Envelope Schema
Every SSE message follows this structure:

```json
id: {timestamp_ms}
event: {event_type}
data: {
  "type": "agent_event | system_event | recovery_event",
  "timestamp": "ISO8601",
  "payload": { ... }
}
```

### Event Types

#### 1. Agent Event (`agent_event`)
Generated by workers (Gemini, Codex, Claude).
```json
{
  "type": "agent_event",
  "agent": "claude",
  "msg_type": "progress | milestone | error | text",
  "payload": {
    "progress": 50,
    "text": "Writing tests...",
    "file": "test_main.py"
  }
}
```

#### 2. Recovery Event (`recovery_event`)
Generated by `PermissionRecoveryEngine`.
```json
{
  "type": "recovery_event",
  "worker": "gemini",
  "issue": "DIR_SCOPE_ERROR",
  "action": "RELAUNCH_WITH_FLAGS",
  "status": "success"
}
```

#### 3. Decision Event (`decision_event`)
Generated by the Orchestrator Review System.
```json
{
  "type": "decision_event",
  "trigger": "MILESTONE",
  "verdict": "CONTINUE",
  "reason": "All agents approved changes."
}
```
